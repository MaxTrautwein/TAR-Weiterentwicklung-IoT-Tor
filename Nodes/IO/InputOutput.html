<script type="text/javascript">
   
    function getJsonConfig(id){
        let jd = undefined;
        let cn = undefined;
        try{
            cn =  RED.nodes.node(id);
            jd = JSON.parse(cn.configur);
        }catch (e) {
            return jd;
        }
        return jd;
   }

    function configureTypedName(conf,dir,id){
        if (conf === undefined ) return;
        let oopt = getOptions(conf,dir);
        $(id).typedInput({
            default:"int",
            type:"int",
            types: [
                {
                    value: "int",
                    options: oopt /*getOptions(dataconf)*/
                }
            ]
        })
   }
   
    var hostParameterValidator = function(node,v){
        if(getMode(node) === "triggered"){
            return true;
        }
        return v != ""
    }
    var getMode = function(node){
        if(node){
            return node.mode
        } else {
            let $mode = $( "#node-input-mode" );
            return $mode.val();
        }
    }

    function getOptions(data,dir){
        if (data == undefined){
            return [{ value: "N/A", label: "N/A"}];
        }
        var Ports = data[dir];
        var Data = [];
        var len = Ports.length;
        for (var i = 0 ; i<len;i++){
            Data.push({value:i, label:Ports[i]["Name"]});
        }
        return Data;
    }
    

    function getNodeLables(data,dir,all,id){
        var Lables = [];
        console.log(all);
        if (all){
            for (var i = 0 ; i<data[dir].length;i++){
            Lables.push(data[dir][i]["Description"]);
            }
        }else{
            var t = data[dir][id];
            if (t === undefined){
                console.log(id);
                return [""];
            }
            Lables.push(data[dir][id]["Description"]);
        }
        return Lables;

    }
    var testLable = ["Test"];

    RED.nodes.registerType('Output',{
        category: 'IO',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            configuration: {value:"",type:"hardware-config" , required:true},
            AusgangName: {value:0},
            allports:{value:false},
            inputs: {value:1}
        },
        outputLabels:["Connect to MQTT Out Node"],
        /*inputLabels:getNodeLables(this,"Output",this.allports,this.AusgangName),*/
        inputs:1,
        outputs:1,
        label: function() {
            if (this.AusgangName != ""){
                let Confnode =  RED.nodes.node(this.configuration);
                let dataconf_l = JSON.parse(Confnode.configur);
                return dataconf_l["Output"][this.AusgangName]["Name"];
            }

            return this.AusgangName||"Output";
        },
        oneditprepare: function(){
            var dataconf_o = getJsonConfig(this.configuration);

            $("#node-input-allports").change(function(){
                if (dataconf_o === undefined) return;
                this.allports =  $("#node-input-allports").prop('checked');
                if(this.allports === true){
                    $("#div-node-input-AusgangName").hide();
                    $("#node-input-inputs").val( dataconf_o["Output"].length);
                }else{
                    $("#div-node-input-AusgangName").show();
                    
                    $("#node-input-inputs").val(1);                 
                }
                //TODO Figgur out how to redraw
                //Working for outputs
            });

            configureTypedName(dataconf_o,"Output","#node-input-AusgangName");

            if (dataconf_o !== undefined) {
                $("#node-input-AusgangName").typedInput("value",this.AusgangName);
                $(".red-ui-typedInput-option-label")[0].innerHTML = getOptions(dataconf_o,"Output")[this.AusgangName].label;
            }
            //Load dataconf once availibale
            $("#node-input-configuration").change(function(){
                let val = $("#node-input-configuration").val();
               
                if (val !== "_ADD_" && val !== "" && val !== undefined){
                    dataconf_o = getJsonConfig(val);
                    configureTypedName(dataconf_o,"Output","#node-input-AusgangName");
                }
            });
        }

    });


    RED.nodes.registerType('Input',{
        category: 'IO',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            configuration: {value:"",type:"hardware-config"},
            EingangName: {value:0},
            allportsi:{value:false},
            outputs: {value:1},
            outputLabels2: {value:[""]}
        },
        inputs:1,
        outputs:1,
        inputLabels:["Connect to MQTT Input #"],
        outputLabels: function(index){
            
            return this.outputLabels2[index];
        },
        
        /* this.outputLabels,*//*function(){
            var res =getNodeLables(this,"Input",this.allportsi,this.EingangName);
            console.log(res);
            return res;
        },*/
        label: function() {
            if (this.AusgangName != ""){
                var Confnode =  RED.nodes.node(this.configuration);
                var dataconf = JSON.parse(Confnode.configur);
                return dataconf["Input"][this.EingangName]["Name"];
            }

            return this.AusgangName||"Input";
        },
        oneditprepare: function(){
            var dataconf = getJsonConfig(this.configuration);

            $("#node-input-allportsi").change(function(){
                if (dataconf === undefined) return;
                this.allportsi =  $("#node-input-allportsi").prop('checked');
                if(this.allportsi === true){
                    $("#div-node-input-EingangName").hide();
                    $("#node-input-outputs").val( dataconf["Input"].length);
                }else{
                    $("#div-node-input-EingangName").show();
                    $("#node-input-outputs").val(1);
                }
                var tmp = getNodeLables(dataconf,"Input",this.allportsi,this.EingangName);
                this.outputLabels2 =  tmp;
            });
            
            configureTypedName(dataconf,"Input","#node-input-EingangName");

            if (dataconf !== undefined) {
                $("#node-input-EingangName").typedInput("value",this.EingangName);
                $(".red-ui-typedInput-option-label")[0].innerHTML = getOptions(dataconf,"Input")[this.EingangName].label;
            }

            //Load dataconf once availibale
            $("#node-input-configuration").change(function(){
                let val = $("#node-input-configuration").val();
               
                if (val !== "_ADD_" && val !== "" && val !== undefined){
                    dataconf = getJsonConfig(val);
                    configureTypedName(dataconf,"Input","#node-input-EingangName");
                }
            });
        }

    });




</script>

<script type="text/html" data-template-name="Output">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-configuration"><i class="fa fa-globe"></i>Configuration</label>
        <input type="text" id="node-input-configuration">
    </div>

    <div class="form-row">
        <label for="node-input-allports"></i>All in One</label>
        <input type="checkbox" id="node-input-allports">
        <input type="hidden" id="node-input-inputs" value="1">
    </div>

    <div id="div-node-input-AusgangName" class="form-row">
        <label for="node-input-AusgangName"></i>Output</label>
        <input type="text" id="node-input-AusgangName">
    </div>
    

</script>

<script type="text/html" data-help-name="Output">
    <p>TBD</p>
</script>

<!-- 
    |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

    |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
-->

<script type="text/html" data-template-name="Input">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-configuration"><i class="fa fa-globe"></i>Configuration</label>
        <input type="text" id="node-input-configuration">
    </div>

    <div class="form-row">
        <label for="node-input-allportsi"></i>All in One</label>
        <input type="checkbox" id="node-input-allportsi">
        <input type="hidden" id="node-input-outputs" value="1">
    </div>

    <div id="div-node-input-EingangName" class="form-row">
        <label for="node-input-EingangName"></i>Input</label>
        <input type="text" id="node-input-EingangName">
    </div>
    

</script>

<script type="text/html" data-help-name="Input">
    <p>TBD</p>
</script>



